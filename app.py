# -*- coding: utf-8 -*-
"""Te damos la bienvenida a Colab

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/notebooks/intro.ipynb
"""

import streamlit as st
import pandas as pd
from datetime import datetime

# ---------------------------------------------
# CONFIGURACI√ìN GENERAL
# ---------------------------------------------
RUTA_EXCEL = "cmms_simulacion_frigorifico.xlsx"

st.set_page_config(
    page_title="CMMS Flota Frigor√≠fica",
    page_icon="‚ùÑÔ∏è",
    layout="wide"
)

# ---------------------------------------------
# FUNCIONES DE BASE DE DATOS (EXCEL)
# ---------------------------------------------
def leer(hoja):
    return pd.read_excel(RUTA_EXCEL, sheet_name=hoja)

def escribir(hoja, df):
    with pd.ExcelWriter(
        RUTA_EXCEL,
        engine="openpyxl",
        mode="a",
        if_sheet_exists="replace"
    ) as writer:
        df.to_excel(writer, sheet_name=hoja, index=False)

# ---------------------------------------------
# INTERFAZ PRINCIPAL
# ---------------------------------------------
st.title("üöö‚ùÑÔ∏è CMMS ‚Äì Gesti√≥n de Flota Frigor√≠fica")

menu = st.sidebar.radio(
    "Men√∫ Principal",
    [
        "Dashboard",
        "Veh√≠culos",
        "Equipos de Fr√≠o",
        "√ìrdenes de Trabajo",
        "Repuestos"
    ]
)

# ---------------------------------------------
# DASHBOARD
# ---------------------------------------------
if menu == "Dashboard":
    veh = leer("Vehiculos")
    ot = leer("OrdenesTrabajo")

    col1, col2, col3 = st.columns(3)
    col1.metric("üöõ Veh√≠culos", len(veh))
    col2.metric("üõ† √ìrdenes", len(ot))
    col3.metric(
        "üîß % Preventivo",
        round((len(ot[ot["tipo"] == "Preventivo"]) / len(ot)) * 100, 2)
        if len(ot) > 0 else 0
    )

    st.subheader("√ìrdenes por tipo")
    st.bar_chart(ot["tipo"].value_counts())

# ---------------------------------------------
# VEH√çCULOS
# ---------------------------------------------
elif menu == "Veh√≠culos":
    st.subheader("üöõ Flota de Veh√≠culos")
    st.dataframe(leer("Vehiculos"), use_container_width=True)

# ---------------------------------------------
# EQUIPOS DE FR√çO
# ---------------------------------------------
elif menu == "Equipos de Fr√≠o":
    st.subheader("‚ùÑÔ∏è Equipos Thermo King")
    st.dataframe(leer("EquiposFrio"), use_container_width=True)

# ---------------------------------------------
# √ìRDENES DE TRABAJO
# ---------------------------------------------
elif menu == "√ìrdenes de Trabajo":
    st.subheader("üõ† √ìrdenes de Trabajo")
    st.dataframe(leer("OrdenesTrabajo"), use_container_width=True)

    st.markdown("### ‚ûï Crear nueva orden")
    col1, col2, col3 = st.columns(3)

    with col1:
        vehiculo = st.number_input("ID Veh√≠culo", 1, 50)
    with col2:
        tipo = st.selectbox("Tipo", ["Preventivo", "Correctivo"])
    with col3:
        tecnico = st.number_input("ID T√©cnico", 1, 4)

    if st.button("Crear Orden"):
        ot = leer("OrdenesTrabajo")
        nueva = {
            "idOT": len(ot) + 1,
            "idVehiculo": vehiculo,
            "idEquipo": vehiculo,
            "tipo": tipo,
            "fechaInicio": datetime.now().strftime("%Y-%m-%d"),
            "fechaFin": "",
            "estado": "Abierta",
            "idTecnico": tecnico
        }
        ot = pd.concat([ot, pd.DataFrame([nueva])], ignore_index=True)
        escribir("OrdenesTrabajo", ot)
        st.success("‚úÖ Orden creada correctamente")

# ---------------------------------------------
# REPUESTOS
# ---------------------------------------------
elif menu == "Repuestos":
    st.subheader("üì¶ Inventario de Repuestos")
    rep = leer("Repuestos")
    st.dataframe(rep, use_container_width=True)

    alerta = rep[rep["stock"] <= rep["stockMinimo"]]
    if not alerta.empty:
        st.error("üö® Repuestos en stock cr√≠tico")
        st.dataframe(alerta, use_container_width=True)
    else:
        st.success("‚úî Stock adecuado")